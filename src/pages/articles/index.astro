---
import { getCollection } from "astro:content";
import PageLayout from "@layouts/PageLayout.astro";
import ArrowCard from "@components/ArrowCard.astro";

const allArticles = (await getCollection("articles"))
  .filter(post => !post.data.draft)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

// Simplified Tag Counting
const tagCounts: Record<string, number> = {};
allArticles.forEach(post => {
  post.data.tags?.forEach(tag => {
    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
  });
});

const allTags = Object.keys(tagCounts).sort();
const allYears = [...new Set(allArticles.map(post => post.data.date.getFullYear().toString()))].sort((a, b) => b.localeCompare(a));

const groupedArticles = allArticles.reduce((acc, post) => {
  const date = post.data.date;
  const monthYear = date.toLocaleDateString("en-GB", {
    month: "short",
    year: "numeric",
  }).toUpperCase();
  
  if (!acc[monthYear]) acc[monthYear] = [];
  acc[monthYear].push(post);
  return acc;
}, {} as Record<string, typeof allArticles>);

const months = Object.keys(groupedArticles);
---

<PageLayout title="Articles">
  <div class="max-w-4xl mx-auto px-6 pt-4 pb-24">
    
    <div class="grid grid-cols-1 md:grid-cols-[100px_1fr] gap-4 mb-12">
      <div class="hidden md:flex flex-col gap-2 pt-2 sticky top-20 h-fit border-r border-black/5 dark:border-white/5 pr-4">
        <span class="text-[9px] font-mono uppercase tracking-widest opacity-30 mb-2">Archive</span>
        <button class="year-filter text-left text-[10px] font-mono uppercase tracking-widest opacity-100 font-bold" data-year="all">All Time</button>
        {allYears.map(year => (
          <button class="year-filter text-left text-[10px] font-mono uppercase tracking-widest opacity-40 hover:opacity-100 transition-opacity" data-year={year}>{year}</button>
        ))}
      </div>

      <div class="space-y-8">
        <div class="space-y-4">
          <input 
            type="text" 
            id="search" 
            placeholder="Search archive..." 
            class="w-full px-4 py-2 bg-black/5 dark:bg-white/5 border border-black/10 dark:border-white/10 rounded-md focus:outline-none font-mono text-sm"
          />

          <div class="flex flex-wrap gap-2 items-center">
            {allTags.map(tag => (
              <button 
                class="tag-filter px-2 py-0.5 text-[10px] font-mono uppercase tracking-widest border border-black/10 dark:border-white/10 rounded-full opacity-50 hover:opacity-100 transition-all" 
                data-tag={tag}
              >
                #{tag} <span class="opacity-30 ml-1">{tagCounts[tag]}</span>
              </button>
            ))}
          </div>
        </div>

        <div id="articles-container" class="space-y-10">
          {months.map(month => (
            <section class="month-group relative grid grid-cols-1 md:grid-cols-[100px_1fr] gap-4 ml-[-104px]">
              <div class="text-[10px] font-mono uppercase tracking-[0.2em] opacity-30 pt-4 sticky top-20 h-fit text-right pr-4">
                {month.split(' ')[0]}
              </div>
              
              <ul class="space-y-2">
                {groupedArticles[month].map(post => (
                  <li 
                    class="article-item" 
                    data-title={post.data.title.toLowerCase()} 
                    data-desc={post.data.description?.toLowerCase() || ''}
                    data-tags={post.data.tags?.join(',').toLowerCase() || ''}
                    data-year={post.data.date.getFullYear().toString()}
                  >
                    <ArrowCard entry={post} />
                  </li>
                ))}
              </ul>
            </section>
          ))}
        </div>
      </div>
    </div>
  </div>
</PageLayout>

<script>
  function initFilters() {
    const search = document.getElementById('search') as HTMLInputElement;
    const yearBtns = document.querySelectorAll('.year-filter');
    const tagBtns = document.querySelectorAll('.tag-filter');
    const items = document.querySelectorAll('.article-item');
    const groups = document.querySelectorAll('.month-group');

    let activeYear = 'all';
    let activeTag = 'all';

    function update() {
      const term = search?.value.toLowerCase() || '';

      items.forEach(item => {
        const t = item.getAttribute('data-title') || '';
        const d = item.getAttribute('data-desc') || '';
        const tg = item.getAttribute('data-tags') || '';
        const y = item.getAttribute('data-year') || '';

        const matchS = t.includes(term) || d.includes(term) || tg.includes(term);
        const matchY = activeYear === 'all' || y === activeYear;
        const matchT = activeTag === 'all' || tg.includes(activeTag.toLowerCase());

        (item as HTMLElement).style.display = (matchS && matchY && matchT) ? 'block' : 'none';
      });

      groups.forEach(g => {
        const visible = g.querySelectorAll('.article-item:not([style*="display: none"])');
        (g as HTMLElement).style.display = visible.length > 0 ? 'grid' : 'none';
      });
    }

    search?.addEventListener('input', update);

    yearBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        yearBtns.forEach(b => {
           b.classList.remove('opacity-100', 'font-bold');
           b.classList.add('opacity-40');
        });
        btn.classList.add('opacity-100', 'font-bold');
        btn.classList.remove('opacity-40');
        activeYear = btn.getAttribute('data-year') || 'all';
        update();
      });
    });

    tagBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const tag = btn.getAttribute('data-tag') || 'all';
        if (activeTag === tag) {
          activeTag = 'all';
          btn.classList.remove('bg-black', 'text-white', 'dark:bg-white', 'dark:text-black');
          btn.classList.add('opacity-50');
        } else {
          tagBtns.forEach(b => {
            b.classList.remove('bg-black', 'text-white', 'dark:bg-white', 'dark:text-black');
            b.classList.add('opacity-50');
          });
          btn.classList.add('bg-black', 'text-white', 'dark:bg-white', 'dark:text-black');
          btn.classList.remove('opacity-50');
          activeTag = tag;
        }
        update();
      });
    });
  }

  document.addEventListener('astro:page-load', initFilters);
  initFilters();
</script>