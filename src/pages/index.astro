---
import { getCollection } from "astro:content";
import PageLayout from "../layouts/PageLayout.astro";
import ArrowCard from "../components/ArrowCard.astro";
import PhotoGalleryGrid from "../components/PhotoGalleryGrid.astro";
import { SITE, SOCIALS } from "../consts";

// 1. Fetch collections
const allPosts = await getCollection("articles");
const allPhotos = await getCollection("photos");

// 2. Simplest possible fetch - No filters, just sorting
const blog = allPosts
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 3);

const featuredPhotos = allPhotos
  .sort((a, b) => {
    // 1. Sort by Weight (Lower numbers first, e.g., 1 comes before 10)
    const weightA = a.data.weight ?? Infinity;
    const weightB = b.data.weight ?? Infinity;
    if (weightA !== weightB) return weightA - weightB;

    // 2. Sort by Date (Newest first)
    const dateA = a.data.date ? new Date(a.data.date).getTime() : 0;
    const dateB = b.data.date ? new Date(b.data.date).getTime() : 0;
    if (dateA !== dateB) return dateB - dateA;

    // 3. Sort by Title (A-Z)
    return a.data.title.localeCompare(b.data.title);
  })
  .slice(0, 9);
---

<PageLayout title="home" description={SITE.DESCRIPTION}>
  
  <section class="animate mt-0 mb-10 flex justify-center">
    <div class="w-full max-w-[350px] aspect-square rounded-2xl overflow-hidden bg-stone-100 dark:bg-stone-900">
      <img 
        src="/hero.png" 
        alt="Hero image" 
        class="w-[101%] h-[101%] -ml-[0.5%] -mt-[0.5%] object-cover"
      />
    </div>
  </section>

  <section class="animate space-y-6">
    <div class="flex flex-wrap items-center justify-between gap-y-2">
      <h2 class="text-xl font-semibold text-black dark:text-white">
        Latest posts
      </h2>
      <a href="/articles" class="group flex items-center gap-1 text-sm font-medium transition-colors hover:text-black dark:hover:text-white text-neutral-500">
        <span>View all posts</span>
        <span class="transition-transform group-hover:translate-x-1">→</span>
      </a>
    </div>
    <ul class="flex flex-col gap-4">
      {blog.length > 0 ? (
        blog.map((post) => (
          <li>
            <ArrowCard entry={post} />
          </li>
        ))
      ) : (
        <p class="text-sm text-neutral-500">No posts found in src/content/blog/</p>
      )}
    </ul>
  </section>

  <section class="animate space-y-6 mt-12">
    <div class="flex flex-wrap items-center justify-between gap-y-2">
      <h2 class="text-xl font-semibold text-black dark:text-white">
        Featured Photo Albums
      </h2>
      <a href="/photos" class="group flex items-center gap-1 text-sm font-medium transition-colors hover:text-black dark:hover:text-white text-neutral-500">
        <span>View all photos</span>
        <span class="transition-transform group-hover:translate-x-1">→</span>
      </a>
    </div>
    
    <PhotoGalleryGrid photos={featuredPhotos} />
  </section>

</PageLayout>