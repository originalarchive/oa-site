---
import { Image } from 'astro:assets';

interface Props {
  folderPath: string;
  images: string[];
  reverse?: boolean; 
}

const { folderPath, images, reverse = false } = Astro.props;

const allImages = import.meta.glob<{ default: ImageMetadata }>('/src/content/**/*.{png,jpg,jpeg,webp}', { eager: true });

// Explicitly type the result and filter out nulls
const galleryImages = images.map(name => {
  const match = Object.keys(allImages).find((key) => 
    key.includes(folderPath) && key.includes(name)
  );
  return match ? allImages[match].default : null;
}).filter((img): img is ImageMetadata => img !== null); // This type guard fixes the build error
---

<div class={`grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-16 items-start my-12 ${reverse ? 'lg:direction-rtl' : ''}`}>
  
  <div class="lg:col-span-5 flex flex-col justify-center min-h-[300px] lg:h-[80vh] lg:sticky lg:top-10">
    <div class="prose prose-sm md:prose-base dark:prose-invert max-w-none lg:pr-8 lg:overflow-y-auto custom-scrollbar">
       <slot />
    </div>
  </div>

  <div class="lg:col-span-7 not-prose h-[60vh] lg:h-[80vh] w-full">
    <div class="swiper editorial-swiper rounded-3xl overflow-hidden shadow-2xl h-full w-full bg-neutral-100 dark:bg-neutral-900 group">
      <div class="swiper-wrapper">
        {galleryImages.map((img) => (
          <div class="swiper-slide h-full">
            <a href={img.src} class="glightbox h-full block w-full">
              <Image 
                src={img} 
                alt="Feature visual" 
                class="w-full h-full object-cover"
                loading="eager"
              />
            </a>
          </div>
        ))}
      </div>
      
      <div class="swiper-button-prev !text-white opacity-0 group-hover:opacity-100 transition-opacity"></div>
      <div class="swiper-button-next !text-white opacity-0 group-hover:opacity-100 transition-opacity"></div>
      <div class="swiper-pagination"></div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
<script is:inline src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<script is:inline>
  function setupSwiper() {
    const swiperEl = document.querySelector('.editorial-swiper');
    // Reference window.Swiper to avoid TS "not found" warnings in some environments
    if (swiperEl && typeof window.Swiper !== 'undefined') {
      new window.Swiper('.editorial-swiper', {
        loop: true,
        slidesPerView: 1,
        spaceBetween: 0,
        observer: true, 
        observeParents: true,
        navigation: {
          nextEl: '.swiper-button-next',
          prevEl: '.swiper-button-prev',
        },
        pagination: {
          el: '.swiper-pagination',
          clickable: true,
        },
      });
    }
  }

  setupSwiper();
  document.addEventListener('astro:after-swap', setupSwiper);
  document.addEventListener('astro:page-load', setupSwiper);
</script>

<style>
  .custom-scrollbar::-webkit-scrollbar {
    width: 3px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: rgba(0,0,0,0.1);
    border-radius: 10px;
  }
  :global(.dark) .custom-scrollbar::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.1);
  }
  
  :global(.swiper-button-next), :global(.swiper-button-prev) {
    background: rgba(0,0,0,0.3);
    backdrop-filter: blur(4px);
    width: 44px !important;
    height: 44px !important;
    border-radius: 50%;
    transform: scale(0.8);
  }
  :global(.swiper-pagination-bullet-active) {
    background: white !important;
  }
</style>