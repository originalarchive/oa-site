---
import type { CollectionEntry } from "astro:content";

interface Props {
  coffeeEntries: CollectionEntry<"coffee">[];
}

const { coffeeEntries } = Astro.props;

const renderedEntries = await Promise.all(
  coffeeEntries.map(async (entry) => {
    const { Content } = await entry.render();
    return { entry, Content };
  })
);

const renderStars = (num: number) => "★".repeat(num) + "☆".repeat(5 - num);
---

<div class="space-y-4">
  {renderedEntries.map(({ entry, Content }) => {
    const d = entry.data;
    const currentStatus = d.rating.overall;

    return (
      <div 
        class="coffee-card group border border-black/10 dark:border-white/10 rounded-xl overflow-hidden bg-white dark:bg-stone-900 shadow-sm transition-all"
        data-date={d.dateBrewed?.toISOString() ?? d.roastDate?.toISOString() ?? new Date().toISOString()}
        data-pantry-status={String(d.status || "Finished")}
      >
        <details class="group/details">
          <summary class="list-none cursor-pointer p-4 sm:p-5">
            <div class="flex justify-between items-start gap-4">
              <div class="space-y-1 flex-1 min-w-0">
                <h3 class="text-lg font-bold leading-tight truncate text-black dark:text-white">{d.name}</h3>
                <p class="text-[12px] opacity-60">
                  <span class="font-bold">{d.roaster}</span> • {d.origin}
                </p>
                <div class="flex gap-4 pt-1 text-[9px] font-mono uppercase tracking-widest opacity-40">
                  <span>Flavor {renderStars(d.rating.flavor)}</span>
                  <span>Body {renderStars(d.rating.body)}</span>
                </div>
              </div>

              <div class="text-right flex flex-col items-end gap-2 shrink-0">
                <div class="text-[10px] font-mono opacity-40 font-bold uppercase">
                  {d.dateBrewed ? d.dateBrewed.toLocaleDateString("en-GB", { day: '2-digit', month: 'short' }) : "OPEN"}
                </div>
                <div class="px-2.5 py-1 rounded border border-black/5 dark:border-white/10 text-[9px] font-bold uppercase tracking-tight bg-stone-50 dark:bg-stone-800">
                  {currentStatus}
                </div>
                <div class="opacity-20 group-hover/details:opacity-60 transition-transform group-open/details:rotate-180">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                </div>
              </div>
            </div>
          </summary>
          <div class="px-5 pb-5 border-t border-black/5 dark:border-white/5 pt-4 text-sm prose prose-stone dark:prose-invert max-w-none">
            <Content />
          </div>
        </details>
      </div>
    );
  })}
</div>