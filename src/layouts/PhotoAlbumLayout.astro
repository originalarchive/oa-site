---
import PageLayout from "./PageLayout.astro";
const { frontmatter } = Astro.props;
---

<PageLayout title={frontmatter.title} description={frontmatter.description}>
  <div class="max-w-7xl mx-auto px-6 py-6">
    
    <nav class="mb-6">
      <a href="/photos" class="text-[10px] font-mono uppercase tracking-[0.3em] text-neutral-500 hover:text-black dark:hover:text-white transition-colors">
        ‚Üê Back to Albums
      </a>
    </nav>
    
    <header class="mb-12">
      <h1 class="text-5xl md:text-7xl font-bold tracking-tighter uppercase text-black dark:text-white leading-none">
        {frontmatter.title}
      </h1>
      
      {frontmatter.tags && (
        <div class="flex flex-wrap gap-4 mt-6">
          {frontmatter.tags.map((tag: string) => (
            <span class="text-[10px] font-mono uppercase tracking-widest text-neutral-400">#{tag}</span>
          ))}
        </div>
      )}
    </header>

    <div class="album-wrapper">
      <div id="intro-text" class="prose prose-neutral dark:prose-invert max-w-2xl mb-12 text-xl leading-relaxed">
        <slot />
      </div>

      <div id="photo-grid" class="columns-1 md:columns-2 lg:columns-3 gap-6 space-y-6">
        {/* Images will be moved here by the script */}
      </div>
    </div>
  </div>

  {/* Lightbox Modal */}
  <div id="lightbox" class="fixed inset-0 bg-white/90 dark:bg-black/95 backdrop-blur-xl z-[100] hidden flex items-center justify-center p-6 md:p-24 cursor-zoom-out">
    <div class="relative w-full h-full max-w-6xl max-h-[90vh] flex items-center justify-center pointer-events-none">
      <img 
        id="lightbox-img" 
        src="" 
        class="max-h-full max-w-full rounded-sm shadow-2xl object-contain pointer-events-auto" 
      />
    </div>
  </div>
</PageLayout>

<style is:global>
  /* 1. HIDE AUTO-GENERATED TITLES (The "Ghost" Fix) */
  .prose > h1:first-child,
  .prose > h2:first-child,
  #intro-text h1,
  #intro-text h2 {
    display: none !important;
  }

  /* 2. FIX INTRO TEXT STYLING */
  #intro-text p {
    font-style: normal !important;
  }

  /* 3. MASONRY GRID STYLING */
  #photo-grid {
    display: block;
    width: 100%;
  }

  #photo-grid img {
    @apply rounded-lg w-full h-auto cursor-zoom-in transition-all duration-500 hover:brightness-110 shadow-sm;
    display: block;
    break-inside: avoid;
    margin-bottom: 1.5rem;
  }

  /* 4. LIGHTBOX TRANSITION */
  #lightbox.flex {
    animation: fadeIn 0.3s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
</style>

<script>
  function initGallery() {
    const intro = document.getElementById('intro-text');
    const grid = document.getElementById('photo-grid');
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightbox-img') as HTMLImageElement;

    if (!intro || !grid) return;

    // 1. DATA MIGRATION: Move images from intro content into the grid
    const images = intro.querySelectorAll('img');
    
    images.forEach((img) => {
      // Create a wrapper or just move the img
      grid.appendChild(img);
    });

    // 2. LIGHTBOX INTERACTION
    grid.addEventListener('click', (e) => {
      const target = e.target as HTMLImageElement;
      if (target.tagName === 'IMG') {
        // If it's a Cloudinary image, we could theoretically swap the width 
        // transformation here for a higher resolution one if needed.
        lightboxImg.src = target.src;
        lightbox?.classList.remove('hidden');
        lightbox?.classList.add('flex');
        document.body.style.overflow = 'hidden';
      }
    });

    lightbox?.addEventListener('click', () => {
      lightbox.classList.add('hidden');
      lightbox.classList.remove('flex');
      document.body.style.overflow = 'auto';
    });
    
    // Close on 'Escape' key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !lightbox?.classList.contains('hidden')) {
        lightbox?.classList.add('hidden');
        document.body.style.overflow = 'auto';
      }
    });
  }

  // Handle both initial load and view transitions
  document.addEventListener('astro:page-load', initGallery);
</script>